<!DOCTYPE html>
<html lang="">

<head>
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="Expires" content="Mon, 06 Jan 1990 00:00:01 GMT" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>p5.js example</title>
  <style>
    * {
      font: 11pt "Calibri";
    }
    body {
      padding: 5px;
      margin: 0;
      background-color: white;
    }
    
    button.ico {
      width: 35px;
      margin: 0 0 2px 0;
      padding: 2px;
      border-width: 1px;
      background-color: honeydew;
    }
    button.ico-sel {
      background-color: beige;
    }
    
    input.stxt {
      font-size: 7.5pt;
      padding: 1px;
      text-align: center;
    }
  </style>
  <script src="libraries/jquery-1.12.4.min.js"></script>
  <script src="libraries/p5.js"></script>
  <script src="libraries/p5.sound.js"></script>
</head>

<body>
  <script src="spritesheet.js" type="text/javascript"></script>
  <script src="sprite.js" type="text/javascript"></script>
  <script src="spring.js" type="text/javascript"></script>
  
  <script src="sketch.js" type="text/javascript"></script>
  <script src="utils.js" type="text/javascript"></script>
  <script src="p5_utils.js" type="text/javascript"></script>
  <script src="geoutils.js" type="text/javascript"></script>
  <script src="vectutils.js" type="text/javascript"></script>
  <script src="poly2d.js" type="text/javascript"></script>
  <script src="player.js" type="text/javascript"></script>
  
  
  <!-- TOOLBAR -->
  <button type="button" class="ico" title="Imposta il primo punto di selezione"
          onclick="javascript: clickTool(this);">1</button>
  <button type="button" class="ico" title="Imposta il secondo punto di selezione"
          onclick="javascript: clickTool(this);">2</button>
  <button type="button" class="ico" title="Attiva spostamento selezione"
          onclick="javascript: clickTool(this);">3</button>
  
  
  <button type="button" class="ico" style="margin-left:10px;" onclick="javascript: zoom(0.1);">Z+</button>
  <button type="button" class="ico" onclick="javascript: zoom(-0.1);">Z-</button>
  <button type="button" class="ico" onclick="javascript: zoom(0.0);">Z0</button>
  <span id="lblZoom">200%</span>
  
  
  <button type="button" class="ico" style="margin-left:10px;" onclick="javascript: adattaSelezione();" title="Adatta la selezione al frame">&gt;&lt;</button>
  <button type="button" class="ico" style="" onclick="javascript: eliminaPunti();" title="Resetta punti di selezione">X</button>
  
  <span id="lblCoord" style="margin-left:20px; color:steelblue;"></span>
  
  <!-- box inserimento frame -->
  <div style="display: inline-block; margin-left:10px;">
    <span id="lblSelArea" style="color:indianred;"></span>
    <input id="txtSpriteName" type="text" style="width:70px; margin-left:8px;" title="Nome frame" />
    <button type="button" class="ico" style="" onclick="javascript: aggAreaSel();" title="Aggiungi frame">+</button>
  </div>
  

  <button type="button" class="ico" style="margin-left:25px;" 
          onclick="javascript: clickTool(this);" title="Editor animazioni">A</button>
  
  
  <span style="margin-left:20px;font-size: 8pt;">SHIFT + frecce: panning</span>
  
  <!-- contenitore canvas P5 -->
  <main>        
  </main>
  
  
  <table cellspacing="2">
  <tr>
    <td valign="top">
      
      <span>Sprite:&nbsp;</span>
      <input id="txtImg" type="text" size="35" 
             value="pix/impossible.png" 
             style="margin: 3px;" />
      <button type="button" onclick="javascript:apriImmagine();">Apri</button>
      <!--<br/>
      <div style="width:314px;display:inline-block;"></div>-->
      <button type="button" onclick="javascript:salvaImmagine();">Salva</button>
      <br/>
      Frame:&nbsp;&nbsp;<input id="txtFrame" type="text" size="5" value="0" /> / <span id="lblNFrame">0</span>        
      <button type="button" onclick="javascript:mostraFrame();" style="margin-left:10px;">Mostra</button>
      <button type="button" onclick="javascript:estraiFrame();" style="margin-left:3px;" title="Estrae e scarica i frame dell'immagine">Estrai</button>

      <br/><br/>
      Backg:
      <input id="txtBackG" type="text" style="width:170px; margin-left:8px;" title="Background" />
      <button type="button" style="" onclick="javascript: cambiaBackground();" title="Cambia background">Cambia</button>
      <br/><br/>
      
      Alpha:
      <input id="txtAlpha" type="text" style="width:170px; margin-left:8px;" title="Componente alpha di trasparenza"
             value="color(192, 220, 192)"/>
      <button type="button" style="" onclick="javascript: impostaAlpha();" title="Imposta componente alpha">Imposta</button>
      <br/>
      
      
      <!-- tabella per adattamento selezione -->
      <div style="margin-top:15px;padding:3px; border:solid 1px gray; display: inline-block;">
      <table>
      <tr>
        <td></td>
        <td>
          <input type="button" value="\/" class="stxt" title="Adatta" onclick="javascript:clickSelNord();" />
          <input type="text" size="5" class="stxt" id="txtSelNord" />
          <input type="button" value="@" class="stxt" title="Cambia" onclick="javascript:cambiaSelNord();" />
        </td>
        <td></td>
      </tr>
      <tr>
        <td>
          <input type="button" value="@" class="stxt" title="Cambia" onclick="javascript:cambiaSelOvest();" />
          <input type="text" size="5" class="stxt" id="txtSelOvest" />
          <input type="button" value=" >" class="stxt" title="Adatta" onclick="javascript:clickSelOvest();" />
        </td>
        <td align="center">Selezione</td>
        <td>
          <input type="button" value="< " class="stxt" title="Adatta" onclick="javascript:clickSelEst();" />
          <input type="text" size="5" class="stxt" id="txtSelEst" />
          <input type="button" value="@" class="stxt" title="Cambia" onclick="javascript:cambiaSelEst();" />
        </td>
      </tr>        
      <tr>
        <td></td>
        <td>
          <input type="button" value="@" class="stxt" title="Cambia" onclick="javascript:cambiaSelSud();" />
          <input type="text" size="5" class="stxt" id="txtSelSud" />
          <input type="button" value="/\" class="stxt" title="Adatta" onclick="javascript:clickSelSud();" />
        </td>
        <td></td>
      </tr>
      </table>
      </div>
      
      
      
    </td>
    <td valign="top">
      <div style="margin-left:20px;">
      
        <span>Sheet:&nbsp;</span>
        <input id="txtSheet" type="text" size="35" value="json/impossible.json" style="margin: 3px 3px 3px 0px;" />
        <button type="button" onclick="javascript:apriSheet();">Apri</button>
        <button type="button" onclick="javascript:aggiornaSheet();" style="margin-left:5px;">Aggiorna</button>
        <button type="button" onclick="javascript:salvaSheet();" style="margin-left:10px;">Salva</button>
        <br/>
        <!-- white-space:nowrap; -->
        <textarea id="txtSheetJSON" 
                  style="font-family: monospace;font-size:8pt; width:492px;height:200px; white-space:nowrap;cursor:auto;overflow:auto;"></textarea>
            
      </div>      
    </td>
  </tr>
  </table>
  
  
  <!-- pannello animazione -->
  <div id="divAnim" style="display:none; width:505px;height:360px;background-color:ghostwhite; overflow-x:hidden;overflow-y:auto;">
    <table cellspacing="0" cellpadding="2">
    <tr>
      <td valign="top">
        <span style="font-weight:bold;">Animazione selezionata</span><br/>        
        <select id="cmbAnim" style="width:150px;"></select><br/>
        <span>Delta time (msec)</span><br/>
        <input id="txtMillis" type="text" size="4" />&nbsp;
        <label for="chkLoop" style="margin-right:3px;"><input id="chkLoop" type="checkbox" />&nbsp;Loop</label>
        <label for="chkExit"><input id="chkExit" type="checkbox" />&nbsp;Exit</label>
        <br/>
        <span>Align/VAlign</span><br/>
        <select id="cmbAlign" type="text">
          <option value="0">Left</option>
          <option value="1" selected="selected">Center</option>
          <option value="2">Right</option></select>
        <select id="cmbVAlign" type="text">
          <option value="0">Top</option>
          <option value="1">Middle</option>
          <option value="2" selected="selected">Bottom</option></select><br/><br/>
        
        <button type="button" class="ico" style="" onclick="javascript:anim_Play();" title="Play">|&gt;</button>
        <button type="button" class="ico" style="" onclick="javascript:anim_Stop();" title="Pause">||</button>
        <button type="button" class="ico" style="margin-right:5px;" onclick="javascript:anim_Stop(true);" title="Stop">[]</button> |
        <button id="cmdFrame" type="button" class="ico" style="margin-left:4px;" 
                onclick="javascript:$(this).toggleClass('ico-sel');" title="Frame">#</button>
        <br/>
        
        <label for="chkRunning" title="Indica se l'animazione è in riproduzione">
          <input id="chkRunning" type="checkbox" /> Esecuz.</label>&nbsp;
        <label for="chkBlocked" title="Indica se lo sprite risulta bloccato nei movimenti">
          <input id="chkBlocked" type="checkbox" /> Bloccato</label>
        <br/><br/>        
        
        <span>Orientamento sprite (gradi)</span><br/>
        <input id="txtDir" type="text" size="5" /><br/>
        <span>Animaz./frame corrente</span><br/>
        <input id="txtCurrAnim" type="text" size="11" />
        <input id="txtCurrFrame" type="text" size="3" value="0" /><br/>
        <span>Larghezza/altezza frame</span><br/>
        <input id="txtWidth" type="text" size="7" />
        <input id="txtHeight" type="text" size="7" /><br/><br/>
        
        <label for="chkGrid"><input id="chkGrid" type="checkbox" />&nbsp;Griglia frame</label><br/>

        <label for="chkKeyb" title="Attiva le animazioni via tastiera (vanno prima specificate le animazioni direzionali)">
          <input id="chkKeyb" type="checkbox" />&nbsp;Tastiera</label><br/><br/>
        <label for="chkPlayG">
          <input id="chkPlayG" type="checkbox" onclick="javascript:checkPlayG();" />&nbsp;Playground</label><br/>
                
        <table border="0">
        <tr>
          <td style="width:0px;"></td>
          <td align="left" colspan="2">
            <label for="chkScroll">
              <input id="chkScroll" type="checkbox" />&nbsp;Scrolling</label><br/>
          </td>
        </tr>
        <tr>
          <td></td>
          <td align="right" style="white-space: nowrap;">
            <label for="chkGrav">
              <input id="chkGrav" type="checkbox" />&nbsp;Gravità:</label><br/>
          </td>
          <td align="left">
            <input id="txtGrav" type="text" size="5" value="2" title="Componente Y del vettore" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td align="right">
            <span>Massa:</span>
          </td>
          <td align="left">
            <input id="txtMass" type="text" size="5" value="1" />
          </td>
        </tr>          
        <tr>
          <td></td>
          <td align="right" style="white-space: nowrap;">
            <span title="Velocità di spostamento">Vel. spost.:</span>
          </td>
          <td align="left">
            <input id="txtVel" type="text" size="5" value="4" title="Componente X/Y del vettore" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td align="right">
            <span title="0: attrito massimo, 1: movimento senza attrito">Attrito:</span>
          </td>
          <td align="left">
            <input id="txtDamp" type="text" size="5" value="0.98" />
          </td>
        </tr>          
        <tr>
          <td></td>
          <td align="right" style="white-space: nowrap;">
            <span title="Velocità massima (magnitudine)">Vel. max:</span>
          </td>
          <td align="left">
            <input id="txtVelMax" type="text" size="5" value="" title="Velocità scalare" />
          </td>
        </tr>    
        <tr>
          <td></td>
          <td align="right" style="white-space: nowrap;">
            <span title="Velocità di azione (tasto CTRL), applicata alle componenti in valore assoluto e con la direzione di movimento">Vel. az.:</span>
          </td>
          <td align="left">
            <input id="txtVelAzX" type="text" size="5" value="90" title="Componente X del vettore" />
            <input id="txtVelAzY" type="text" size="5" value="-25" title="Componente Y del vettore" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td align="right">
            <span title="Forza di opposizione (tasto ALT)">Forza opp.:</span>
          </td>
          <td align="left">
            <input id="txtForzaX" type="text" size="5" value="-1" title="Componente X del vettore" />
            <input id="txtForzaY" type="text" size="5" value="-1" title="Componente Y del vettore" />
          </td>
        </tr>
        <tr><td colspan="3"><hr /></td></tr>
        <tr>
          <td colspan="3">
            <span>Posizione</span><br/>
            <input id="txtPosVX" type="text" size="9" />
            <input id="txtPosVY" type="text" size="9" /><br/>
            <span>Posizione attuale</span><br/>
            <input id="txtActPosVX" type="text" size="9" />
            <input id="txtActPosVY" type="text" size="9" /><br/>
            <span>Veloc. vett.</span><br/>
            <input id="txtVelVX" type="text" size="9" />
            <input id="txtVelVY" type="text" size="9" /><br/>
            <span>Accelerazione</span><br/>
            <input id="txtAccVX" type="text" size="9" />
            <input id="txtAccVY" type="text" size="9" /><br/>
            <label for="chkInMov">
              <input id="chkInMov" type="checkbox" />&nbsp;In movimento</label><br/>
          </td>
        </tr>
        </table>
        
                        
      </td>
      
      <td><div style="width:8px;"></div></td>
      
      <td id="tdAnimDx" valign="top">
        <span style="color:steelblue;font-weight:bold;">Impostazioni</span><br/>

        <button id="cmdEditAnim" type="button" class="ico" style="width:50px;" onclick="javascript: anim_Edit();" title="Modalità Edit">Edit</button>
        <button id="cmdUpdAnim" type="button" class="ico" style="width:70px; margin-right:10px;" 
                disabled="disabled" onclick="javascript: anim_Update();" title="Aggiorna modifiche">Aggiorna</button>        
        <br/><br/>
                
        <span style="font-weight:bold;">Animazione/frame di riferim.</span><br/>
        <input id="txtAnimRef" type="text" size="18" />
        <input id="txtFrameRef" type="text" size="2" value="0" />
        <br/>
        <span style="font-weight:bold;">Larghezza/altezza di riferim.</span><br/>
        <input id="txtWidthRef" type="text" size="10" />
        <input id="txtHeightRef" type="text" size="10" /><br/><br/>
        
        
        <table cellspacing="8">
        <tr>
          <td><a href="#" title="Animazioni direzionali di movimento"
                 onclick="javascript: $('table[id^=tabDirAnim]').hide(); $('#tabDirAnim0').show(); return false;">Dir. Mov.</a>&nbsp;&nbsp;|</td>
          <td><a href="#" title="Animazioni direzionali in idle"
                 onclick="javascript: $('table[id^=tabDirAnim]').hide(); $('#tabDirAnim1').show(); return false;">Dir. Idle</a>&nbsp;&nbsp;|</td>
          <td><a href="#" title="Animazioni direzionali extra (tasto CTRL)"
                 onclick="javascript: $('table[id^=tabDirAnim]').hide(); $('#tabDirAnim2').show(); return false;">Dir. Extra</a></td>
        </tr>
        </table>
                
        <!-- animazioni di direzione movimento -->
        <table id="tabDirAnim0">
        <tr>
          <td><input id="txtDirNW" type="text" size="7" /></td>
          <td><input id="txtDirN" type="text" size="7" /></td>
          <td><input id="txtDirNE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td><input id="txtDirW" type="text" size="7" /></td>
          <td align="center" title="Animazioni direzionali di movimento (frecce)">Dir. Mov.</td>
          <td><input id="txtDirE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td><input id="txtDirSW" type="text" size="7" /></td>
          <td><input id="txtDirS" type="text" size="7" /></td>
          <td><input id="txtDirSE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td colspan="3"><input id="txtDirJSON" type="text" style="width:96%;" title="JSON dell'array dei codici di animazione (da E verso SE)" /></td>
        </tr>
        </table>

        <!-- animazioni di direzione idle -->
        <table id="tabDirAnim1" style="display:none;">
        <tr>
          <td><input id="txtIdleNW" type="text" size="7" /></td>
          <td><input id="txtIdleN" type="text" size="7" /></td>
          <td><input id="txtIdleNE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td><input id="txtIdleW" type="text" size="7" /></td>
          <td align="center" title="Animazioni direzionali in idle">Dir. Idle</td>
          <td><input id="txtIdleE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td><input id="txtIdleSW" type="text" size="7" /></td>
          <td><input id="txtIdleS" type="text" size="7" /></td>
          <td><input id="txtIdleSE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td colspan="3"><input id="txtIdleJSON" type="text" style="width:96%;" title="JSON dell'array dei codici di animazione (da E verso SE)" /></td>
        </tr>
        </table>

        <!-- animazioni di direzione extra (tasto CTRL) -->
        <table id="tabDirAnim2" style="display:none;">
        <tr>
          <td><input id="txtExtraNW" type="text" size="7" /></td>
          <td><input id="txtExtraN" type="text" size="7" /></td>
          <td><input id="txtExtraNE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td><input id="txtExtraW" type="text" size="7" /></td>
          <td align="center" title="Animazioni direzionali extra (tasto CTRL)">Dir. Extra</td>
          <td><input id="txtExtraE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td><input id="txtExtraSW" type="text" size="7" /></td>
          <td><input id="txtExtraS" type="text" size="7" /></td>
          <td><input id="txtExtraSE" type="text" size="7" /></td>
        </tr>
        <tr>
          <td colspan="3"><input id="txtExtraJSON" type="text" style="width:96%;" title="JSON dell'array dei codici di animazione (da E verso SE)" /></td>
        </tr>
        </table>
        <br/>
        
        <input type="text" size="22" style="visibility:hidden;" />
        <button type="button" onclick="javascript:salvaSprite();" 
                title="Salva impostazioni sprite">&nbsp;Salva&nbsp;</button><br/>
        <input id="txtJSONSprite" type="text" size="22" value="json/sprite.json"
               title="Percorso al file JSON di salvataggio impostazioni" />
        <button type="button" onclick="javascript:caricaSprite();" style="margin-top:3px;"
                title="Carica impostazioni sprite">Carica</button>

        
      </td>
    </tr>
    </table>
    
    
    
    <br/>    
  </div>
  <!-- fine pannello animazione -->
  
  
    
  <script language="JavaScript" type="text/javascript">
  
    $(function() {
      
      //$(document).on("keydown", function(e) {
      //  console.log(e.which);
      //});
      
    });
    
    
    function apriImmagine() {
      var sImg = $("#txtImg").val();
      p5_apriImmagine(sImg);
    }
  
    function salvaImmagine() {
      if(_imgSheet) {
        _imgSheet.save('sprite', 'png');
      } // if(_imgSheet)
    }
    
    function mostraFrame() {
      var sIFrame = $("#txtFrame").val();
      if(sIFrame != "") _imgFrame = parseInt(sIFrame);
    }
    
    function estraiFrame() {
      let txtImg = select("#txtImg");
      let bGIF = (txtImg.value().toLowerCase().indexOf(".gif") > -1);    

      if(_imgLoaded && bGIF) {
        //let graph = createGraphics(_imgSheet.width, _imgSheet.height);
        let aImgs = [];
        
        let sNFile = txtImg.value();
        let iPos = sNFile.lastIndexOf('/');
        if(iPos < 0) iPos = 0;
        else iPos++;
        sNFile = sNFile.substring(iPos);
        sNFile = sNFile.split('.')[0];
        
        let sNF = "";
        const iNF = _imgSheet.numFrames();
        for(let i = 0; i < iNF; i++) {
          _imgSheet.setFrame(i);
                    
          //graph.clear();
          //graph.copy(_imgSheet, 0, 0, _imgSheet.width, _imgSheet.height, 0, 0, graph.width, graph.height);
          
          let imgFrame2 = createImage(_imgSheet.width, _imgSheet.height);
          imgFrame2.copy(_imgSheet, 0, 0, _imgSheet.width, _imgSheet.height, 
                                    0, 0, imgFrame2.width, imgFrame2.height);              
          aImgs.push(imgFrame2);
          
          sNF = i.toString();
          const iNK = 4 - sNF.length;
          for(let k=0; k < iNK; k++) sNF = '0' + sNF;
          
          setTimeout(
            function( img, sNFile, sNF ) {
              img.save(`${sNFile}_${sNF}`, 'png');            
            }, 1500 * (i + 1), imgFrame2, sNFile, sNF);
          
        } // for(let i = 0; i < iNF; i++)

      } // if(_imgLoaded && bGIF)  
    } // estraiFrame
    
    
    function clickTool(elem) {
      jElem = $(elem);
      let bPremuto = jElem.hasClass("ico-sel");
      let oldLineMode = _lineMode;
            
      $("button.ico").removeClass("ico-sel");
      _lineMode = "";
      
      // se viene premuto un pulsante
      if(!bPremuto) {
        // modalità linea 
        _lineMode = jElem.text(); 
        jElem.addClass('ico-sel');
                  
      } // if(!bPremuto)
      else {
        // se viene rilasciato un pulsante
        switch(oldLineMode) {
          case "1":
            //_pnt0.indef = true;
            break;
          case "2":
            //_pnt1.indef = true;
            break;
          case "3":
            break;
            
          // tool di animazione (chiusura)
          case "A":            
            // elimina i frame di animazione potenzialmente generati dallo spritesheet
            p5_resetAnimazioni();
                        
            $("#divAnim").hide();
            break;
            
          default:
            break;
        } // switch(_oldLineMode)
        
      } // if(!bPremuto)      
    }
    
    function zoom( dz ) {
      if(dz == 0.1 && _iScale == 1.0) {
        if(_iPrevZoom > 1.0)
          _iScale = _iPrevZoom;
        else {
          _iScale = 2.000000000000001;
          _iPrevZoom = _iScale;
        }          
      }        
      else {
        _iScale += dz;        
        _iPrevZoom = _iScale;
      } // if(dz == 0.1 && _iScale == 1.0)
      
      if(dz == 0 || _iScale < 1.0) _iScale = 1.0;
      let perc = floor(_iScale * 100);
      $("#lblZoom").text(perc + "%");
      
      //p5_ridimCanvas();
      
      // flag del pannello zoom attivo
      _bZoom = (_iScale != 1.0);
    }    
    
    function eliminaPunti() {
      if(confirm("Resettare i punti di selezione?")) {
        _pnt0.indef = true;
        _pnt1.indef = true;
      } // if(confirm ...      
    } // eliminaPunti
    
    
    function apriSheet() {
      
      _txtSheet = loadJSON($("#txtSheet").val(), "json", 
        function(e) {
          console.log(e);
          $("#txtSheetJSON").val(JSON.stringify(_txtSheet, null, 2));

          p5_resetAnimazioni();
        },
        function(e) {
          console.log(e); 
          alert("Errore durante il caricamento dello sheet!");
          p5_resetAnimazioni();
        });
      
    }
    
    function aggiornaSheet() {
      _txtSheet = JSON.parse($("#txtSheetJSON").val());
      p5_resetAnimazioni();
    }
    
    function aggAreaSel() {    
      if(_bSelArea) {
        
        // costruisce l'oggetto che verrà aggiunto allo sheet
        let frame = {
          name: $("#txtSpriteName").val(),
          type: "raster",
          position: {
            x: _pnt0.x - ceil(CVS_PANX),
            y: _pnt0.y - ceil(CVS_PANY),
            w: (_pnt1.x - _pnt0.x),
            h: (_pnt1.y - _pnt0.y)
          },
          sound: ""
        };
        
        // aggiunge il frame allo sheet
        _txtSheet.frames.push(frame);
        // aggiorna la casella di testo dello sheet
        $("#txtSheetJSON").val(JSON.stringify(_txtSheet, null, 2));        
        
        let iPos = $("#txtSheetJSON").val().indexOf( '"' + $("#txtSpriteName").val() + '"' );
        if( iPos > -1 )
          setSelectionRange($("#txtSheetJSON")[0], iPos, iPos + $("#txtSpriteName").val().length + 2);
        
        // pulizia nome frame e punti per ricominciare
        $("#txtSpriteName").val("");
        //_pnt0.indef = true;
        //_pnt1.indef = true;

        p5_resetAnimazioni();        
      } // if(_bSelArea)      
    } // aggAreaSel
    
    
    function salvaSheet() {
      
      //saveJSON(_txtSheet, "");
      save(_txtSheet, "sheet.json");
      
    } // salvaSheet
    
    
    function salvaSprite() {
    
      // genera una versione salvabile dello sprite 
      // (senza le informazioni sui frame elaborate dallo spritesheet)
      let oSpr = new Sprite({
        name: _sprite.name,
        animRef: _sprite.animRef,
        frameRef: _sprite.frameRef,
        widthRef: _sprite.widthRef,
        heightRef: _sprite.heightRef,
        width: _sprite.width,
        height: _sprite.height,
        mass: _sprite.mass,
        damping: _sprite.damping,
        maxSpeed: _sprite.maxSpeed, 
      });
      
      oSpr.id = _sprite.id;
      oSpr.hitBox = {
        width: _sprite.hitBox.width,
        height: _sprite.hitBox.height,
        position: null,
        posCenter: null
      };
      oSpr.hitDelta = _sprite.hitDelta;
      oSpr.dirAngle = _sprite.dirAngle;
      oSpr.visible = _sprite.visible;
      oSpr.transf = _sprite.transf;
      oSpr.filter = _sprite.filter;
      
      // esegue una copia dei dati delle animazioni (senza frame e informazioni 
      // non serializzabili, come ad es. immagini e suoni)      
      for(const sAnim in _sprite.anim) {
        
        let newAnim = {
          name: _sprite.anim[sAnim].name,
          desc: _sprite.anim[sAnim].desc,
          frames: [],
          loop: _sprite.anim[sAnim].loop,
          blocking: _sprite.anim[sAnim].blocking,
          millis: _sprite.anim[sAnim].millis,
          align: _sprite.anim[sAnim].align,
          valign: _sprite.anim[sAnim].valign,
          transf: _sprite.anim[sAnim].transf
        };        
        oSpr.anim[sAnim] = newAnim;
        
      } // for(const sAnim in _sprite.anim)
      
      // copia dell'array animList
      oSpr.animList = [];
      for(let i=0; i < _sprite.animList.length; i++) {
        oSpr.animList[i] = _sprite.animList[i];
      }
            
      // copia degli array di animazioni di direzione
      oSpr.dirAnim = [];
      for(let i=0; i < _sprite.dirAnim.length; i++) {
        oSpr.dirAnim[i] = _sprite.dirAnim[i];
      }
      oSpr.idleAnim = [];
      for(let i=0; i < _sprite.idleAnim.length; i++) {
        oSpr.idleAnim[i] = _sprite.idleAnim[i];
      }

      oSpr.extraAnim = [];
      for(let i=0; i < _sprite.extraAnim.length; i++) {
        oSpr.extraAnim[i] = [];        
        for(let k=0; k < _sprite.extraAnim[i].length; k++) {
          oSpr.extraAnim[i][k] = _sprite.extraAnim[i][k];          
        } // for(let k=0; k < _sprite.extraAnim[i].length; k++)        
      } // for(let i=0; i < _sprite.extraAnim.length; i++)
            
      // elimina tutti i vettori P5 perchè non serializzabili
      oSpr.position = null;
      oSpr.offsetPos = null;
      oSpr.actualPos = null;
      oSpr.prevPos = null;
      oSpr.velocity = null;
      oSpr.acceleration = null;
      oSpr.direction = null;
      oSpr.gravity = null;
      
      // annulla altri oggetti potenzialmente non serializzabili
      oSpr.springs = [];
      oSpr.spriteSheet = null;
      oSpr.player = null;
      oSpr.snd = [];
      
      // chiama il download del codice serializzato dello sprite
      console.log(oSpr);
      //save(JSON.stringify(oSpr), "sprite.json");
      save(oSpr, "sprite.json");
      
      alert("Attenzione: il file salvato contiene le sole informazioni serializzabili dello sprite. " +
            "Per ricaricarle occorre eseguire nuovamente la costruzione dello spritesheet e " +
            "in seguito il caricamento delle informazioni salvate.");
      
    } // salvaSprite
    
    function caricaSprite() {
      const sPathN = $("#txtJSONSprite").val();
            
      let oSpr = loadJSON(sPathN, "json", 
        function(e) {
          //console.log(e);        
          if(confirm("Sovrascrivere le impostazioni dello sprite corrente?")) {
            
            //_sprite.id = oSpr.id;
            _sprite.name = oSpr.name;
            _sprite.animRef = oSpr.animRef;
            _sprite.frameRef = oSpr.frameRef;
            _sprite.widthRef = oSpr.widthRef;
            _sprite.heightRef = oSpr.heightRef;
            _sprite.width = oSpr.width;
            _sprite.height = oSpr.height;
            _sprite.mass = oSpr.mass;
            _sprite.damping = oSpr.damping;
            _sprite.maxSpeed = oSpr.maxSpeed;
            _sprite.dirAngle = oSpr.dirAngle;
            _sprite.hitDelta = oSpr.hitDelta;
            _sprite.scale = oSpr.scale;
            _sprite.rotation = oSpr.rotation;
            
            // esegue una copia dei dati di impostazione delle animazioni
            for(const sAnim in oSpr.anim) {
              
              _sprite.anim[sAnim].align = oSpr.anim[sAnim].align;
              _sprite.anim[sAnim].loop = oSpr.anim[sAnim].loop;
              _sprite.anim[sAnim].millis = oSpr.anim[sAnim].millis;
              _sprite.anim[sAnim].name = oSpr.anim[sAnim].name;
              _sprite.anim[sAnim].valign = oSpr.anim[sAnim].valign;
              _sprite.anim[sAnim].blocking = oSpr.anim[sAnim].blocking;

            } // for(const sAnim in oSpr.anim)
            
            // copia dell'array animList
            _sprite.animList = [];
            for(let i=0; i < oSpr.animList.length; i++) {
              _sprite.animList[i] = oSpr.animList[i];
            }
            
            // copia degli array di animazioni di direzione
            _sprite.dirAnim = [];
            for(let i=0; i < oSpr.dirAnim.length; i++) {
              _sprite.dirAnim[i] = oSpr.dirAnim[i];
            }
            _sprite.idleAnim = [];
            for(let i=0; i < oSpr.idleAnim.length; i++) {
              _sprite.idleAnim[i] = oSpr.idleAnim[i];
            }

            _sprite.extraAnim = [];
            for(let i=0; i < oSpr.extraAnim.length; i++) {
              _sprite.extraAnim[i] = [];
              for(let k=0; k < oSpr.extraAnim[i].length; k++) {
                _sprite.extraAnim[i][k] = oSpr.extraAnim[i][k];
              } // for(let k=0; k < oSpr.extraAnim[i].length; k++)
            } // for(let i=0; i < oSpr.extraAnim.length; i++)
            
            
          } // if(confirm())        
        },
        function(e) {
          console.log(e); 
          alert("Errore durante il caricamento dello sprite!");        
        });
            
    } // caricaSprite
    
    
    function cambiaBackground() {
      
      _sBackG = $("#txtBackG").val();
      
    } // cambiaBackground
    
    
    function impostaAlpha() {
      if(!_imgLoaded || !_imgSheet) {
        alert("Caricare un'immagine per lo spritesheet prima di procedere.");
        return;
      }
      if(!_sheet) {
        alert("Accedere all'editor di animazioni prima di procedere.");
        return;        
      }
      
      if(confirm("Il nuovo colore di trasparenza si aggiungerà all'eventuale colore impostato in precedenza, finchè l'immagine non verrà ricaricata.\nProcedere?")) {
        // colore impostato con una funzione "color(rosso, verde, blu)"
        let col = eval($("#txtAlpha").val());

        //_sheet.setTransparent(img, color(192, 220, 192));
        _sheet.setTransparent(_imgSheet, col);
        
        alert("Colore di trasparenza applicato.\nChiudere e riaprire il tool di animazione per rendere effettive le modifiche.");
         
      } // if(confirm( ...      
    } // impostaAlpha
    
    
    function checkPlayG() {
      const bPlayG = $("#chkPlayG").is(":checked");
      const bGrav = $("#chkGrav").is(":checked");
      
      if(bPlayG && _sprite) {        
        //console.log("check: " + VIEW_WIDTH2);
        //_sprite.position.x = 10 + (VIEW_WIDTH2 / 10);
        //_sprite.position.y = VIEW_HEIGHT - 34 - _sprite.height;
        // offset di partenza per Perlin noise
        //_perlinX = 0.1;        
        
        // la posizione verrà impostata poi dalla funzione di animazione
        _sprite.position.set(0, 0);
        
      } // if(bVal && _sprite)      
    } // checkPlayG

    
    // stringe la selezione per eliminare le righe/colonne di pixel vuoti (trasparenti) presenti nei 4 lati
    function adattaSelezione() {
      if(_imgLoaded && _bSelArea) {
        
        colorMode(RGB);
        pixelDensity(1);
        
        _imgSheet.loadPixels();
        

        let iRet = adattaSelezNord(_imgSheet, _pnt0, _pnt1);
        _pnt0.y = iRet + ceil(CVS_PANY);

        iRet = adattaSelezSud(_imgSheet, _pnt0, _pnt1);
        _pnt1.y = iRet + ceil(CVS_PANY);
        
        iRet = adattaSelezOvest(_imgSheet, _pnt0, _pnt1);
        _pnt0.x = iRet + ceil(CVS_PANX);
        
        iRet = adattaSelezEst(_imgSheet, _pnt0, _pnt1);
        _pnt1.x = iRet + ceil(CVS_PANX);
        
        
        $("#txtSelNord").val(_pnt0.y - ceil(CVS_PANY));
        $("#txtSelSud").val(_pnt1.y - ceil(CVS_PANY));
        $("#txtSelOvest").val(_pnt0.x - ceil(CVS_PANX));
        $("#txtSelEst").val(_pnt1.x - ceil(CVS_PANX));
        
        // rende persistenti le modifiche effettuate
        //img.updatePixels();  
        
      } // if(_imgLoaded && _bSelArea)      
    } // adattaSelezione
    
    function adattaSelezNord( img, pnt0, pnt1 ) {      
      let yS = pnt0.y - ceil(CVS_PANY), yF = pnt1.y - ceil(CVS_PANY);
      let xS = pnt0.x - ceil(CVS_PANX), xF = pnt1.x - ceil(CVS_PANX);        
      let iRet = yS;

      // scansione segmenti orizzontali di immagine variando le ordinate:
      // da _pt0.y verso _pt1.y
      console.log("yS: " + yS);
      let bExit = false;
      for(let y = yS; y < yF && !bExit; y++) {
        for(let x = xS; x < xF; x++) {

          // posizionamento al pixel di riferimento
          const i = (y * img.width + x) * 4;
          // estrazione delle componenti di colore del pixel
          const c = [ img.pixels[i], img.pixels[i + 1],
                      img.pixels[i + 2], img.pixels[i + 3] ];
          //console.log(c);

          // testa la la componente alpha del colore per verificare che sia trasparente
          if( c[3] !== 0 ) {
            // in questo caso interrompe i cicli presupponendo che la riga precedente
            // sia l'ultima a contenere solo pixel trasparenti
            bExit = true;
            break;
          } // if( c[3] !== 0 )

        } // for(let x = _pt0.x; x < _pt1.x; x++)

        if( !bExit ) iRet = y;
      } // for(let y = yS; y < yF; y++)

      console.log("iRet: " + iRet);
      
      return iRet;
    } // adattaSelezNord
    
    function adattaSelezSud( img, pnt0, pnt1 ) {      
      let yS = pnt0.y - ceil(CVS_PANY), yF = pnt1.y - ceil(CVS_PANY);
      let xS = pnt0.x - ceil(CVS_PANX), xF = pnt1.x - ceil(CVS_PANX);        
      let iRet = yF;
      
      // scansione segmenti orizzontali di immagine variando le ordinate:
      // da _pt1.y verso _pt0.y
      console.log("yF: " + yF);
      let bExit = false;
      for(let y = yF; y > yS && !bExit; y--) {
        for(let x = xS; x < xF; x++) {

          // posizionamento al pixel di riferimento
          const i = (y * img.width + x) * 4;
          // estrazione delle componenti di colore del pixel
          const c = [ img.pixels[i], img.pixels[i + 1],
                      img.pixels[i + 2], img.pixels[i + 3] ];
          //console.log(c);

          // testa la la componente alpha del colore per verificare che sia trasparente
          if( c[3] !== 0 ) {
            // in questo caso interrompe i cicli presupponendo che la riga precedente
            // sia l'ultima a contenere solo pixel trasparenti
            bExit = true;
            break;
          } // if( c[3] !== 0 )

        } // for(let x = _pt0.x; x < _pt1.x; x++)

        if( !bExit ) iRet = y;
      } // for(let y = yF; y > yS && !bExit; y--)

      console.log("iRet: " + iRet);
      return iRet;
    } // adattaSelezSud
    
    function adattaSelezOvest( img, pnt0, pnt1 ) {      
      let yS = pnt0.y - ceil(CVS_PANY), yF = pnt1.y - ceil(CVS_PANY);
      let xS = pnt0.x - ceil(CVS_PANX), xF = pnt1.x - ceil(CVS_PANX);        
      let iRet = xS;

      // scansione segmenti vericali di immagine variando le ascisse:
      // da _pt0.x verso _pt1.x
      console.log("xS: " + xS);
      let bExit = false;
      for(let x = xS; x < xF && !bExit; x++) {
        for(let y = yS; y < yF; y++) {

          // posizionamento al pixel di riferimento
          const i = (y * img.width + x) * 4;
          // estrazione delle componenti di colore del pixel
          const c = [ img.pixels[i], img.pixels[i + 1],
                      img.pixels[i + 2], img.pixels[i + 3] ];
          //console.log(c);

          // testa la la componente alpha del colore per verificare che sia trasparente
          if( c[3] !== 0 ) {
            // in questo caso interrompe i cicli presupponendo che la riga precedente
            // sia l'ultima a contenere solo pixel trasparenti
            bExit = true;
            break;
          } // if( c[3] !== 0 )

        } // for(let y = yS; y < yF; y++)

        if( !bExit ) iRet = x;
      } // for(let x = xS; x < xF && !bExit; x++)

      console.log("iRet: " + iRet);      
      return iRet;
    } // adattaSelezOvest
    
    function adattaSelezEst( img, pnt0, pnt1 ) {      
      let yS = pnt0.y - ceil(CVS_PANY), yF = pnt1.y - ceil(CVS_PANY);
      let xS = pnt0.x - ceil(CVS_PANX), xF = pnt1.x - ceil(CVS_PANX);        
      let iRet = xF;

      // scansione segmenti vericali di immagine variando le ascisse:
      // da _pt1.x verso _pt0.x
      console.log("xF: " + xF);
      let bExit = false;
      for(let x = xF; x > xS && !bExit; x--) {
        for(let y = yS; y < yF; y++) {

          // posizionamento al pixel di riferimento
          const i = (y * img.width + x) * 4;
          // estrazione delle componenti di colore del pixel
          const c = [ img.pixels[i], img.pixels[i + 1],
                      img.pixels[i + 2], img.pixels[i + 3] ];
          //console.log(c);

          // testa la la componente alpha del colore per verificare che sia trasparente
          if( c[3] !== 0 ) {
            // in questo caso interrompe i cicli presupponendo che la riga precedente
            // sia l'ultima a contenere solo pixel trasparenti
            bExit = true;
            break;
          } // if( c[3] !== 0 )

        } // for(let y = yS; y < yF; y++)

        if( !bExit ) iRet = x;
      } // for(let x = xF; x > xS && !bExit; x--)

      console.log("iRet: " + iRet);            
      return iRet;
    } // adattaSelezEst
    
    
    function clickSelNord() {
      let iTxt = int($("#txtSelNord").val());
      if(isNaN(iTxt)) return;
      
      colorMode(RGB);
      pixelDensity(1);

      _imgSheet.loadPixels();
      
      let iRet = adattaSelezNord(_imgSheet, _pnt0, _pnt1);
      _pnt0.y = iRet + ceil(CVS_PANY);
      
      aggiornaTxtSel();
      
    } // clickSelNord
    
    function clickSelSud() {
      let iTxt = int($("#txtSelSud").val());
      if(isNaN(iTxt)) return;

      colorMode(RGB);
      pixelDensity(1);

      _imgSheet.loadPixels();
            
      let iRet = adattaSelezSud(_imgSheet, _pnt0, _pnt1);
      _pnt1.y = iRet + ceil(CVS_PANY);
      
      aggiornaTxtSel();
      
    } // clickSelSud

    function clickSelOvest() {
      let iTxt = int($("#txtSelOvest").val());
      if(isNaN(iTxt)) return;
      
      colorMode(RGB);
      pixelDensity(1);

      _imgSheet.loadPixels();
      
      let iRet = adattaSelezOvest(_imgSheet, _pnt0, _pnt1);
      _pnt0.x = iRet + ceil(CVS_PANX);
      
      aggiornaTxtSel();
      
    } // clickSelOvest

    function clickSelEst() {
      let iTxt = int($("#txtSelEst").val());
      if(isNaN(iTxt)) return;
      
      colorMode(RGB);
      pixelDensity(1);

      _imgSheet.loadPixels();
      
      let iRet = adattaSelezEst(_imgSheet, _pnt0, _pnt1);
      _pnt1.x = iRet + ceil(CVS_PANX);
      
      aggiornaTxtSel();
      
    } // clickSelEst


    function cambiaSelNord() {
      let iTxt = int($("#txtSelNord").val());
      if(isNaN(iTxt)) return;
      
      _pnt0.y = iTxt + ceil(CVS_PANY);
    } // cambiaSelNord
    
    function cambiaSelSud() {
      let iTxt = int($("#txtSelSud").val());
      if(isNaN(iTxt)) return;
      
      _pnt1.y = iTxt + ceil(CVS_PANY);      
    } // cambiaSelSud

    function cambiaSelOvest() {
      let iTxt = int($("#txtSelOvest").val());
      if(isNaN(iTxt)) return;
      
      _pnt0.x = iTxt + ceil(CVS_PANX);
    } // cambiaSelOvest

    function cambiaSelEst() {
      let iTxt = int($("#txtSelEst").val());
      if(isNaN(iTxt)) return;
      
      _pnt1.x = iTxt + ceil(CVS_PANX);
    } // cambiaSelEst
    
    
    function aggiornaTxtSel() {
      let y0 = _pnt0.y - ceil(CVS_PANY);
      if(isNaN(y0)) y0 = "";
      let y1 = _pnt1.y - ceil(CVS_PANY);
      if(isNaN(y1)) y1 = "";
      let x0 = _pnt0.x - ceil(CVS_PANX);
      if(isNaN(x0)) x0 = "";
      let x1 = _pnt1.x - ceil(CVS_PANX);
      if(isNaN(x1)) x1 = "";

      $("#txtSelNord").val(y0);
      $("#txtSelSud").val(y1);
      $("#txtSelOvest").val(x0);
      $("#txtSelEst").val(x1);

    } // aggiornaTxtSel
    
    
    // Lancia un evento dall'elemento HTML passato. Es.: triggerEvent("click", oDiv1);
    function triggerEvent(sEventName, oElem) {

      var evt = null;
      try { evt = new CustomEvent(sEventName, { bubbles: true, cancelable: true }); }
      catch (e) {
        evt = document.createEvent('Event');
        evt.initEvent(sEventName, true, true); //can bubble, and is cancellable
      }
      oElem.dispatchEvent(evt);

    } // triggerEvent

    function setSelectionRange(textarea, selectionStart, selectionEnd) {
        // First scroll selection region to view
        const fullText = textarea.value;
        textarea.value = fullText.substring(0, selectionEnd);
        // For some unknown reason, you must store the scollHeight to a variable
        // before setting the textarea value. Otherwise it won't work for long strings
        const scrollHeight = textarea.scrollHeight;
        textarea.value = fullText;
        let scrollTop = scrollHeight;
        const textareaHeight = textarea.clientHeight;
        if (scrollTop > textareaHeight){
            // scroll selection to center of textarea
            scrollTop -= textareaHeight / 2;
        } else{
            scrollTop = 0;
        }
        textarea.scrollTop = scrollTop;

        // Continue to set selection range
        textarea.setSelectionRange(selectionStart, selectionEnd);
    }
    
    
  </script>
  
</body>

</html>